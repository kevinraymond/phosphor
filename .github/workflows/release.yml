name: Release

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - name: macOS-arm64
            os: macos-latest
            target: aarch64-apple-darwin
          - name: macOS-x86_64
            os: macos-latest
            target: x86_64-apple-darwin
          - name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev libpulse-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.target }}-v2

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} --features "video,ndi"

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          STAGING="phosphor-${TAG}-${{ matrix.target }}"
          mkdir -p "$STAGING"
          cp "target/${{ matrix.target }}/release/phosphor-app" "$STAGING/phosphor"
          cp -r assets "$STAGING/assets"
          [ -f README.md ] && cp README.md "$STAGING/"
          [ -f LICENSE-MIT ] && cp LICENSE-MIT "$STAGING/"
          [ -f LICENSE-APACHE ] && cp LICENSE-APACHE "$STAGING/"
          [ -f LICENSE ] && cp LICENSE "$STAGING/"
          tar czf "${STAGING}.tar.gz" "$STAGING"
          echo "ASSET=${STAGING}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace '^refs/tags/', ''
          $staging = "phosphor-${tag}-${{ matrix.target }}"
          New-Item -ItemType Directory -Path $staging
          Copy-Item "target/${{ matrix.target }}/release/phosphor-app.exe" "$staging/phosphor.exe"
          Copy-Item -Recurse "assets" "$staging/assets"
          if (Test-Path "README.md") { Copy-Item "README.md" "$staging/" }
          if (Test-Path "LICENSE-MIT") { Copy-Item "LICENSE-MIT" "$staging/" }
          if (Test-Path "LICENSE-APACHE") { Copy-Item "LICENSE-APACHE" "$staging/" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$staging/" }
          Compress-Archive -Path "$staging" -DestinationPath "${staging}.zip"
          "ASSET=${staging}.zip" | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Upload artifact (macOS binary for universal job)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/phosphor-app

      - name: Upload artifact
        if: runner.os != 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-${{ matrix.target }}
          path: ${{ env.ASSET }}

  universal-macos:
    name: macOS Universal Binary (sign + notarize)
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-aarch64-apple-darwin
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-x86_64-apple-darwin
          path: artifacts/x86_64

      - name: Create universal .app, sign, notarize, and staple
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Import certificate
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          rm certificate.p12

          # Install create-dmg for polished DMG
          brew install create-dmg

          # Create universal binary from per-arch builds
          APP="Phosphor.app"
          mkdir -p "$APP/Contents/MacOS"
          mkdir -p "$APP/Contents/Resources"
          lipo -create artifacts/arm64/phosphor-app artifacts/x86_64/phosphor-app -output "$APP/Contents/MacOS/Phosphor"
          chmod +x "$APP/Contents/MacOS/Phosphor"
          cp -r assets "$APP/Contents/Resources/assets"
          sed "s/__VERSION__/$VERSION/g" packaging/macos/Info.plist > "$APP/Contents/Info.plist"

          # Generate .icns from source PNG
          ICONSET="Phosphor.iconset"
          mkdir -p "$ICONSET"
          for size in 16 32 64 128 256 512 1024; do
            sips -z $size $size packaging/icon/icon_1024x1024.png --out "$ICONSET/icon_${size}x${size}.png" >/dev/null
          done
          cp "$ICONSET/icon_32x32.png"     "$ICONSET/icon_16x16@2x.png"
          cp "$ICONSET/icon_64x64.png"     "$ICONSET/icon_32x32@2x.png"
          cp "$ICONSET/icon_256x256.png"   "$ICONSET/icon_128x128@2x.png"
          cp "$ICONSET/icon_512x512.png"   "$ICONSET/icon_256x256@2x.png"
          cp "$ICONSET/icon_1024x1024.png" "$ICONSET/icon_512x512@2x.png"
          rm "$ICONSET/icon_64x64.png" "$ICONSET/icon_1024x1024.png"
          iconutil --convert icns "$ICONSET" --output "$APP/Contents/Resources/Phosphor.icns"
          rm -rf "$ICONSET"

          # Codesign the bundle
          codesign --force --deep --options runtime \
            --entitlements packaging/macos/entitlements.plist \
            --sign "Developer ID Application" "$APP" --timestamp
          codesign --verify --verbose "$APP"

          # Create polished DMG with drag-to-Applications
          DMG="phosphor-${TAG}-universal-apple-darwin.dmg"
          VOLICON="$APP/Contents/Resources/Phosphor.icns"
          mkdir -p dmg_staging
          mv "$APP" dmg_staging/
          create-dmg \
            --volname "Phosphor" \
            --volicon "dmg_staging/$VOLICON" \
            --background "packaging/macos/dmg_background.png" \
            --window-pos 200 120 \
            --window-size 660 400 \
            --icon-size 128 \
            --icon "Phosphor.app" 180 190 \
            --hide-extension "Phosphor.app" \
            --app-drop-link 480 190 \
            --no-internet-enable \
            "$DMG" \
            "dmg_staging/" \
          || hdiutil create -volname "Phosphor" -srcfolder "dmg_staging" -ov -format UDZO "$DMG"
          xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple "$DMG"

          echo "ASSET=${DMG}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-universal-apple-darwin
          path: ${{ env.ASSET }}

  release:
    name: Publish Release
    needs: [build, universal-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS universal artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-universal-apple-darwin
          path: artifacts/macos

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-x86_64-unknown-linux-gnu
          path: artifacts/linux

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-x86_64-pc-windows-msvc
          path: artifacts/windows

      - name: List artifacts
        run: find artifacts -type f

      - name: Build release notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          # Extract this version's section from CHANGELOG.md (between ## vX.Y.Z headers)
          awk "/^## v${VERSION}[[:space:]]/{found=1; next} found && /^## /{exit} found{print}" CHANGELOG.md > release_notes.md
          # Append static footer (downloads table, getting started, requirements)
          cat .github/release-notes-footer.md >> release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: artifacts/**/*
