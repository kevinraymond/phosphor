name: Release

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            archive: tar.gz
          - name: macOS-arm64
            os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz
          - name: macOS-x86_64
            os: macos-latest
            target: x86_64-apple-darwin
            archive: tar.gz
          - name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
    steps:
      - uses: actions/checkout@v4

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} --features video

      - name: Codesign (macOS)
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Import certificate into a temporary keychain
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          rm certificate.p12

          # Sign the binary
          BINARY="target/${{ matrix.target }}/release/phosphor-app"
          codesign --force --options runtime --sign "Developer ID Application" "$BINARY" --timestamp
          codesign --verify --verbose "$BINARY"

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          STAGING="phosphor-${TAG}-${{ matrix.target }}"
          mkdir -p "$STAGING"
          cp "target/${{ matrix.target }}/release/phosphor-app" "$STAGING/phosphor"
          cp -r assets "$STAGING/assets"
          [ -f README.md ] && cp README.md "$STAGING/"
          [ -f LICENSE-MIT ] && cp LICENSE-MIT "$STAGING/"
          [ -f LICENSE-APACHE ] && cp LICENSE-APACHE "$STAGING/"
          [ -f LICENSE ] && cp LICENSE "$STAGING/"
          tar czf "${STAGING}.tar.gz" "$STAGING"
          echo "ASSET=${STAGING}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace '^refs/tags/', ''
          $staging = "phosphor-${tag}-${{ matrix.target }}"
          New-Item -ItemType Directory -Path $staging
          Copy-Item "target/${{ matrix.target }}/release/phosphor-app.exe" "$staging/phosphor.exe"
          Copy-Item -Recurse "assets" "$staging/assets"
          if (Test-Path "README.md") { Copy-Item "README.md" "$staging/" }
          if (Test-Path "LICENSE-MIT") { Copy-Item "LICENSE-MIT" "$staging/" }
          if (Test-Path "LICENSE-APACHE") { Copy-Item "LICENSE-APACHE" "$staging/" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$staging/" }
          Compress-Archive -Path "$staging" -DestinationPath "${staging}.zip"
          "ASSET=${staging}.zip" | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-${{ matrix.target }}
          path: ${{ env.ASSET }}

  universal-macos:
    name: macOS Universal Binary (sign + notarize)
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-aarch64-apple-darwin
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-x86_64-apple-darwin
          path: artifacts/x86_64

      - name: Import certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          rm certificate.p12

      - name: Create universal binary, sign, and notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"

          # Extract both archives
          cd artifacts/arm64 && tar xzf *.tar.gz && cd ../..
          cd artifacts/x86_64 && tar xzf *.tar.gz && cd ../..

          # Find the extracted binaries
          ARM_BIN=$(find artifacts/arm64 -name phosphor -type f)
          X86_BIN=$(find artifacts/x86_64 -name phosphor -type f)

          # Create universal binary
          STAGING="phosphor-${TAG}-universal-apple-darwin"
          mkdir -p "$STAGING"
          lipo -create "$ARM_BIN" "$X86_BIN" -output "$STAGING/phosphor"
          chmod +x "$STAGING/phosphor"
          cp -r assets "$STAGING/assets"
          [ -f README.md ] && cp README.md "$STAGING/"
          [ -f LICENSE-MIT ] && cp LICENSE-MIT "$STAGING/"
          [ -f LICENSE-APACHE ] && cp LICENSE-APACHE "$STAGING/"
          [ -f LICENSE ] && cp LICENSE "$STAGING/"

          # Codesign the universal binary
          codesign --force --options runtime --sign "Developer ID Application" "$STAGING/phosphor" --timestamp
          codesign --verify --verbose "$STAGING/phosphor"

          # Notarize: zip the binary, submit, wait, staple
          ditto -c -k "$STAGING/phosphor" phosphor-notarize.zip
          xcrun notarytool submit phosphor-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          rm phosphor-notarize.zip

          # Package final tarball
          tar czf "${STAGING}.tar.gz" "$STAGING"
          echo "ASSET=${STAGING}.tar.gz" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-universal-apple-darwin
          path: ${{ env.ASSET }}

  release:
    name: Publish Release
    needs: [build, universal-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/**/*
