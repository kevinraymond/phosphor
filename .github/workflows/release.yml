name: Release

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - name: macOS-arm64
            os: macos-latest
            target: aarch64-apple-darwin
          - name: macOS-x86_64
            os: macos-latest
            target: x86_64-apple-darwin
          - name: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libudev-dev

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.os }}-${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }} --features video

      - name: Package and sign (macOS)
        if: runner.os == 'macOS'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Import certificate
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          rm certificate.p12

          # Create .app bundle
          APP="Phosphor.app"
          mkdir -p "$APP/Contents/MacOS"
          mkdir -p "$APP/Contents/Resources"
          cp "target/${{ matrix.target }}/release/phosphor-app" "$APP/Contents/MacOS/Phosphor"
          cp -r assets "$APP/Contents/Resources/assets"
          sed "s/__VERSION__/$VERSION/g" packaging/macos/Info.plist > "$APP/Contents/Info.plist"

          # Codesign the bundle
          codesign --force --deep --options runtime --sign "Developer ID Application" "$APP" --timestamp
          codesign --verify --verbose "$APP"

          # Create DMG containing the .app
          DMG="phosphor-${TAG}-${{ matrix.target }}.dmg"
          hdiutil create -volname "Phosphor" -srcfolder "$APP" -ov -format UDZO "$DMG" || \
            (sleep 5 && hdiutil create -volname "Phosphor" -srcfolder "$APP" -ov -format UDZO "$DMG")

          # Notarize and staple
          xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple "$DMG"

          echo "ASSET=${DMG}" >> "$GITHUB_ENV"

      - name: Package (Linux)
        if: runner.os == 'Linux'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          STAGING="phosphor-${TAG}-${{ matrix.target }}"
          mkdir -p "$STAGING"
          cp "target/${{ matrix.target }}/release/phosphor-app" "$STAGING/phosphor"
          cp -r assets "$STAGING/assets"
          [ -f README.md ] && cp README.md "$STAGING/"
          [ -f LICENSE-MIT ] && cp LICENSE-MIT "$STAGING/"
          [ -f LICENSE-APACHE ] && cp LICENSE-APACHE "$STAGING/"
          [ -f LICENSE ] && cp LICENSE "$STAGING/"
          tar czf "${STAGING}.tar.gz" "$STAGING"
          echo "ASSET=${STAGING}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF -replace '^refs/tags/', ''
          $staging = "phosphor-${tag}-${{ matrix.target }}"
          New-Item -ItemType Directory -Path $staging
          Copy-Item "target/${{ matrix.target }}/release/phosphor-app.exe" "$staging/phosphor.exe"
          Copy-Item -Recurse "assets" "$staging/assets"
          if (Test-Path "README.md") { Copy-Item "README.md" "$staging/" }
          if (Test-Path "LICENSE-MIT") { Copy-Item "LICENSE-MIT" "$staging/" }
          if (Test-Path "LICENSE-APACHE") { Copy-Item "LICENSE-APACHE" "$staging/" }
          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$staging/" }
          Compress-Archive -Path "$staging" -DestinationPath "${staging}.zip"
          "ASSET=${staging}.zip" | Out-File -Append -FilePath $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-${{ matrix.target }}
          path: ${{ env.ASSET }}

  universal-macos:
    name: macOS Universal Binary (sign + notarize)
    needs: build
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-aarch64-apple-darwin
          path: artifacts/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: phosphor-x86_64-apple-darwin
          path: artifacts/x86_64

      - name: Create universal .app, sign, notarize, and staple
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Import certificate
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="actions"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          rm certificate.p12

          # Mount per-arch DMGs and extract binaries
          ARM_MNT=$(mktemp -d)
          X86_MNT=$(mktemp -d)
          hdiutil attach artifacts/arm64/*.dmg -mountpoint "$ARM_MNT" -nobrowse -quiet
          hdiutil attach artifacts/x86_64/*.dmg -mountpoint "$X86_MNT" -nobrowse -quiet
          ARM_BIN=$(find "$ARM_MNT" -name Phosphor -type f -path "*/MacOS/*")
          X86_BIN=$(find "$X86_MNT" -name Phosphor -type f -path "*/MacOS/*")

          # Create universal .app bundle
          APP="Phosphor.app"
          mkdir -p "$APP/Contents/MacOS"
          mkdir -p "$APP/Contents/Resources"
          lipo -create "$ARM_BIN" "$X86_BIN" -output "$APP/Contents/MacOS/Phosphor"
          chmod +x "$APP/Contents/MacOS/Phosphor"
          cp -r assets "$APP/Contents/Resources/assets"
          sed "s/__VERSION__/$VERSION/g" packaging/macos/Info.plist > "$APP/Contents/Info.plist"

          hdiutil detach "$ARM_MNT" -quiet
          hdiutil detach "$X86_MNT" -quiet

          # Codesign the bundle
          codesign --force --deep --options runtime --sign "Developer ID Application" "$APP" --timestamp
          codesign --verify --verbose "$APP"

          # Create DMG, notarize, staple
          DMG="phosphor-${TAG}-universal-apple-darwin.dmg"
          hdiutil create -volname "Phosphor" -srcfolder "$APP" -ov -format UDZO "$DMG" || \
            (sleep 5 && hdiutil create -volname "Phosphor" -srcfolder "$APP" -ov -format UDZO "$DMG")
          xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait
          xcrun stapler staple "$DMG"

          echo "ASSET=${DMG}" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phosphor-universal-apple-darwin
          path: ${{ env.ASSET }}

  release:
    name: Publish Release
    needs: [build, universal-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/**/*
